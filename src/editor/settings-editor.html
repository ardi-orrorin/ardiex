<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ardiex Settings Editor</title>
    <style>
      :root {
        --bg: #0f172a;
        --surface: #1e293b;
        --surface2: #334155;
        --border: #475569;
        --text: #e2e8f0;
        --text-muted: #94a3b8;
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --danger: #ef4444;
        --danger-hover: #dc2626;
        --success: #22c55e;
        --warning: #f59e0b;
        --radius: 8px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 24px;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      h1 .badge {
        font-size: 0.7rem;
        background: var(--primary);
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
      }

      .subtitle {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 24px;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      button {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--surface);
        color: var(--text);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.15s;
      }

      button:hover {
        background: var(--surface2);
      }

      button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
      }
      .btn-primary:hover {
        background: var(--primary-hover);
      }

      .btn-danger {
        background: var(--danger);
        border-color: var(--danger);
      }
      .btn-danger:hover {
        background: var(--danger-hover);
      }

      .btn-sm {
        padding: 4px 10px;
        font-size: 0.8rem;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 16px;
      }

      .card h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
      }

      .field {
        display: grid;
        grid-template-columns: 200px 1fr;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .field label {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-weight: 500;
      }

      input[type="text"],
      input[type="number"],
      select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg);
        color: var(--text);
        font-size: 0.85rem;
        width: 100%;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
      }

      input.invalid {
        border-color: var(--danger);
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.25);
      }

      .checkbox-field {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
      }

      .source-card {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        margin-bottom: 12px;
      }

      .source-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .source-header h3 {
        font-size: 0.95rem;
        font-weight: 600;
        word-break: break-all;
      }

      .source-header .actions {
        display: flex;
        gap: 6px;
        flex-shrink: 0;
      }

      .backup-dirs {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .backup-dir-row {
        display: flex;
        gap: 6px;
        align-items: center;
        width: 100%;
      }

      .backup-dir-row input {
        flex: 1;
      }

      .backup-dir-row .path-input-group {
        flex: 1;
        min-width: 0;
      }

      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .tag-enabled {
        background: rgba(34, 197, 94, 0.15);
        color: var(--success);
      }
      .tag-disabled {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      .override-row {
        display: grid;
        grid-template-columns: 160px 1fr 60px;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
      }

      .override-row label {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 20px;
        border-radius: var(--radius);
        font-size: 0.85rem;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
      }

      .toast-success {
        background: var(--success);
        color: #000;
      }
      .toast-error {
        background: var(--danger);
        color: #fff;
      }

      @keyframes slideIn {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .json-preview {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        font-family: "SF Mono", "Fira Code", monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 400px;
        overflow-y: auto;
        color: var(--text-muted);
        display: none;
      }

      .json-preview-actions {
        display: none;
        justify-content: flex-end;
        margin-bottom: 8px;
      }

      .section-toggle {
        cursor: pointer;
        user-select: none;
      }

      .section-toggle::before {
        content: "â–¸ ";
      }

      .section-toggle.open::before {
        content: "â–¾ ";
      }

      .help-text {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .path-input-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .path-input-group input {
        flex: 1;
      }

      .btn-browse {
        padding: 8px 10px;
        font-size: 0.8rem;
        white-space: nowrap;
        background: var(--surface2);
        border-color: var(--border);
        flex-shrink: 0;
      }

      .btn-browse:hover {
        background: var(--primary);
        border-color: var(--primary);
      }

      .btn-create {
        padding: 8px 10px;
        font-size: 0.8rem;
        white-space: nowrap;
        background: var(--surface2);
        border-color: var(--border);
        flex-shrink: 0;
      }

      .btn-create:hover {
        background: var(--success);
        border-color: var(--success);
        color: #000;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        width: 480px;
        max-width: 90vw;
      }

      .modal h3 {
        font-size: 1rem;
        margin-bottom: 16px;
      }

      .modal .field {
        margin-bottom: 12px;
      }

      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 16px;
      }

      .dnd-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.75);
        border: 2px dashed var(--primary);
        z-index: 3000;
        pointer-events: none;
      }

      .dnd-overlay.active {
        display: flex;
      }

      .dnd-box {
        background: rgba(30, 41, 59, 0.95);
        border: 1px solid var(--primary);
        color: var(--text);
        padding: 16px 20px;
        border-radius: var(--radius);
        font-size: 0.95rem;
        font-weight: 600;
      }

      @media (max-width: 640px) {
        .field {
          grid-template-columns: 1fr;
        }
        .override-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <h1>Ardiex Settings Editor <span class="badge">v0.0.2</span></h1>
    <p class="subtitle">settings.json íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ì„œ í¸ì§‘í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.</p>

    <div class="toolbar">
      <button class="btn-primary" onclick="newConfig()">ğŸ“„ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
      <button class="btn-primary" onclick="loadFile()">ğŸ“‚ íŒŒì¼ ì—´ê¸°</button>
      <button id="save-btn" class="btn-primary" onclick="saveFile()" disabled>ğŸ’¾ ì €ì¥</button>
      <button onclick="downloadFile()">â¬‡ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="togglePreview()">{ } JSON ë¯¸ë¦¬ë³´ê¸°</button>
      <button onclick="validateConfig()">âœ“ ê²€ì¦</button>
    </div>

    <div id="dnd-overlay" class="dnd-overlay">
      <div class="dnd-box">settings.json íŒŒì¼ì„ í™”ë©´ ì•„ë¬´ ê³³ì—ë‚˜ ë†“ìœ¼ì„¸ìš”</div>
    </div>

    <div id="json-preview-actions" class="json-preview-actions">
      <button class="btn-sm" onclick="copyPreviewJson()">ğŸ“‹ ë¯¸ë¦¬ë³´ê¸° JSON ë³µì‚¬</button>
    </div>
    <div id="json-preview" class="json-preview"></div>

    <!-- Global Settings -->
    <div class="card">
      <h2>ê¸€ë¡œë²Œ ì„¤ì •</h2>

      <div class="field">
        <label>enable_periodic</label>
        <div class="checkbox-field">
          <input type="checkbox" id="g-enable-periodic" checked />
          <span class="help-text">ì£¼ê¸°ì  ë°±ì—… í™œì„±í™”</span>
        </div>
      </div>
      <div class="field">
        <label>enable_event_driven</label>
        <div class="checkbox-field">
          <input type="checkbox" id="g-enable-event" checked />
          <span class="help-text">íŒŒì¼ ë³€ê²½ ê°ì§€ ë°±ì—… í™œì„±í™”</span>
        </div>
      </div>
      <div class="field">
        <label>max_backups</label>
        <input type="number" id="g-max-backups" min="1" value="10" />
      </div>
      <div class="field">
        <label>backup_mode</label>
        <select id="g-backup-mode">
          <option value="delta">delta</option>
          <option value="copy">copy</option>
        </select>
      </div>
      <div class="field">
        <label>full_backup_interval</label>
        <input type="number" id="g-full-interval" min="1" value="10" />
      </div>
      <div class="field">
        <label>cron_schedule</label>
        <div class="path-input-group">
          <input type="text" id="g-cron" value="0 0 * * * *" />
          <button class="btn-browse btn-sm" onclick="openCronBuilder('global')">ğŸ• ë¹Œë”</button>
        </div>
        <div class="help-text" style="margin-top: 6px">
          <strong>6í•„ë“œ í˜•ì‹:</strong> ì´ˆ ë¶„ ì‹œ ì¼ ì›” ìš”ì¼ &nbsp;
          <span style="color: var(--text-muted)">| ì¼ë°˜ crontab(5í•„ë“œ) ì•ì— <code>0 </code> ì¶”ê°€</span>
        </div>
        <details style="margin-top: 6px; font-size: 0.8rem; color: var(--text-muted)">
          <summary style="cursor: pointer; color: var(--primary)">Cron í‘œí˜„ì‹ ê°€ì´ë“œ ë³´ê¸°</summary>
          <div
            style="
              margin-top: 8px;
              padding: 10px;
              background: var(--bg);
              border-radius: var(--radius);
              line-height: 1.6;
            ">
            <pre style="margin: 0; font-size: 0.75rem; color: var(--text)">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆ (0-59)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€ ë¶„ (0-59)
â”‚ â”‚ â”Œâ”€â”€â”€â”€ ì‹œ (0-23)
â”‚ â”‚ â”‚ â”Œâ”€â”€ ì¼ (1-31)
â”‚ â”‚ â”‚ â”‚ â”Œ ì›” (1-12)
â”‚ â”‚ â”‚ â”‚ â”‚ â”Œ ìš”ì¼ (0-6, 0=ì¼)
* * * * * *</pre
            >
            <table style="width: 100%; margin-top: 8px; border-collapse: collapse; font-size: 0.75rem">
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 0 * * * *</code></td>
                <td>ë§¤ì‹œ ì •ê° (ê¸°ë³¸ê°’)</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 */30 * * * *</code></td>
                <td>30ë¶„ë§ˆë‹¤</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 */5 * * * *</code></td>
                <td>5ë¶„ë§ˆë‹¤</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 0 */2 * * *</code></td>
                <td>2ì‹œê°„ë§ˆë‹¤</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 0 9 * * *</code></td>
                <td>ë§¤ì¼ ì˜¤ì „ 9ì‹œ</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 0 0 * * *</code></td>
                <td>ë§¤ì¼ ìì •</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border)">
                <td style="padding: 3px 6px"><code>0 0 9 * * 1-5</code></td>
                <td>í‰ì¼ ì˜¤ì „ 9ì‹œ</td>
              </tr>
              <tr>
                <td style="padding: 3px 6px"><code>0 0 0 1 * *</code></td>
                <td>ë§¤ì›” 1ì¼ ìì •</td>
              </tr>
            </table>
            <p style="margin-top: 8px">
              <strong>íŠ¹ìˆ˜ ë¬¸ì:</strong> <code>*</code> ëª¨ë“  ê°’ &nbsp; <code>*/N</code> N ê°„ê²© &nbsp;
              <code>N-M</code> ë²”ìœ„ &nbsp; <code>N,M</code> ëª©ë¡
            </p>
            <p style="margin-top: 4px">
              5í•„ë“œ í™•ì¸:
              <a href="https://crontab.guru" target="_blank" style="color: var(--primary)">crontab.guru</a> (ì•ì—
              <code>0 </code> ì¶”ê°€)
            </p>
          </div>
        </details>
      </div>
      <div class="field">
        <label>enable_min_interval_by_size</label>
        <div class="checkbox-field">
          <input type="checkbox" id="g-min-interval" checked />
          <span class="help-text">ìš©ëŸ‰ ê¸°ë°˜ ìµœì†Œ ë°±ì—… ì£¼ê¸°</span>
        </div>
      </div>
      <div class="field">
        <label>exclude_patterns</label>
        <input type="text" id="g-exclude" value="*.tmp, *.log, .git/*, .DS_Store" />
      </div>
      <p class="help-text" style="margin-top: 4px">exclude_patterns: ì‰¼í‘œë¡œ êµ¬ë¶„</p>
    </div>

    <!-- Sources -->
    <div class="card">
      <h2 style="display: flex; justify-content: space-between; align-items: center">
        ì†ŒìŠ¤ ëª©ë¡
        <button class="btn-primary btn-sm" onclick="addSource()">+ ì†ŒìŠ¤ ì¶”ê°€</button>
      </h2>
      <div id="sources-container"></div>
    </div>

    <input type="file" id="file-input" accept=".json" style="display: none" onchange="handleFileLoad(event)" />

    <!-- Modal: Browse (manual path input helper) -->
    <div class="modal-overlay" id="modal-browse">
      <div class="modal">
        <h3>ğŸ“‚ í´ë” ê²½ë¡œ ì„ íƒ</h3>
        <div class="field" style="grid-template-columns: 1fr">
          <label>ì ˆëŒ€ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
          <input type="text" id="browse-path" placeholder="/home/user/documents" />
        </div>
        <p class="help-text">
          í„°ë¯¸ë„ì—ì„œ <code>pwd</code> ë˜ëŠ” <code>realpath .</code> ëª…ë ¹ìœ¼ë¡œ ì ˆëŒ€ê²½ë¡œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <div class="modal-actions">
          <button onclick="closeModal('modal-browse')">ì·¨ì†Œ</button>
          <button class="btn-primary" onclick="confirmBrowse()">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- Modal: Cron Builder -->
    <div class="modal-overlay" id="modal-cron">
      <div class="modal" style="width: 560px">
        <h3>ğŸ• Cron í‘œí˜„ì‹ ë¹Œë”</h3>
        <p class="help-text" style="margin-bottom: 12px">ì›í•˜ëŠ” ì£¼ê¸°ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ cron í‘œí˜„ì‹ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>

        <div class="field" style="grid-template-columns: 1fr">
          <label>í”„ë¦¬ì…‹ ì„ íƒ</label>
          <select id="cron-preset" onchange="applyCronPreset()">
            <option value="">ì§ì ‘ ì„¤ì •...</option>
            <option value="0 */5 * * * *">5ë¶„ë§ˆë‹¤</option>
            <option value="0 */10 * * * *">10ë¶„ë§ˆë‹¤</option>
            <option value="0 */30 * * * *">30ë¶„ë§ˆë‹¤</option>
            <option value="0 0 * * * *">ë§¤ì‹œ ì •ê°</option>
            <option value="0 0 */2 * * *">2ì‹œê°„ë§ˆë‹¤</option>
            <option value="0 0 */6 * * *">6ì‹œê°„ë§ˆë‹¤</option>
            <option value="0 0 */12 * * *">12ì‹œê°„ë§ˆë‹¤</option>
            <option value="0 0 0 * * *">ë§¤ì¼ ìì •</option>
            <option value="0 0 9 * * *">ë§¤ì¼ ì˜¤ì „ 9ì‹œ</option>
            <option value="0 0 9 * * 1-5">í‰ì¼ ì˜¤ì „ 9ì‹œ</option>
            <option value="0 0 0 * * 0">ë§¤ì£¼ ì¼ìš”ì¼ ìì •</option>
            <option value="0 0 0 1 * *">ë§¤ì›” 1ì¼ ìì •</option>
          </select>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px">
          <div class="field" style="grid-template-columns: 1fr">
            <label>ì´ˆ (0-59)</label>
            <select id="cron-sec" onchange="updateCronPreview()">
              <option value="0">0 (ê³ ì •)</option>
              <option value="*">ë§¤ì´ˆ (*)</option>
              <option value="*/10">10ì´ˆë§ˆë‹¤</option>
              <option value="*/15">15ì´ˆë§ˆë‹¤</option>
              <option value="*/30">30ì´ˆë§ˆë‹¤</option>
            </select>
          </div>
          <div class="field" style="grid-template-columns: 1fr">
            <label>ë¶„ (0-59)</label>
            <select id="cron-min" onchange="updateCronPreview()">
              <option value="0">0 (ì •ê°)</option>
              <option value="*">ë§¤ë¶„ (*)</option>
              <option value="*/5">5ë¶„ë§ˆë‹¤</option>
              <option value="*/10">10ë¶„ë§ˆë‹¤</option>
              <option value="*/15">15ë¶„ë§ˆë‹¤</option>
              <option value="*/30">30ë¶„ë§ˆë‹¤</option>
            </select>
          </div>
          <div class="field" style="grid-template-columns: 1fr">
            <label>ì‹œ (0-23)</label>
            <select id="cron-hour" onchange="updateCronPreview()">
              <option value="*">ë§¤ì‹œ (*)</option>
              <option value="*/2">2ì‹œê°„ë§ˆë‹¤</option>
              <option value="*/6">6ì‹œê°„ë§ˆë‹¤</option>
              <option value="*/12">12ì‹œê°„ë§ˆë‹¤</option>
              <option value="0">ìì • (0)</option>
              <option value="6">ì˜¤ì „ 6ì‹œ</option>
              <option value="9">ì˜¤ì „ 9ì‹œ</option>
              <option value="12">ì •ì˜¤ (12)</option>
              <option value="18">ì˜¤í›„ 6ì‹œ</option>
              <option value="21">ì˜¤í›„ 9ì‹œ</option>
              <option value="9-17">ì—…ë¬´ì‹œê°„ (9-17)</option>
            </select>
          </div>
          <div class="field" style="grid-template-columns: 1fr">
            <label>ì¼ (1-31)</label>
            <select id="cron-day" onchange="updateCronPreview()">
              <option value="*">ë§¤ì¼ (*)</option>
              <option value="1">1ì¼</option>
              <option value="15">15ì¼</option>
              <option value="1,15">1ì¼, 15ì¼</option>
            </select>
          </div>
          <div class="field" style="grid-template-columns: 1fr">
            <label>ì›” (1-12)</label>
            <select id="cron-month" onchange="updateCronPreview()">
              <option value="*">ë§¤ì›” (*)</option>
              <option value="*/3">ë¶„ê¸°ë§ˆë‹¤</option>
              <option value="*/6">ë°˜ê¸°ë§ˆë‹¤</option>
            </select>
          </div>
          <div class="field" style="grid-template-columns: 1fr">
            <label>ìš”ì¼ (0-6)</label>
            <select id="cron-dow" onchange="updateCronPreview()">
              <option value="*">ë§¤ì¼ (*)</option>
              <option value="1-5">í‰ì¼ (ì›”-ê¸ˆ)</option>
              <option value="0,6">ì£¼ë§ (í† ,ì¼)</option>
              <option value="0">ì¼ìš”ì¼</option>
              <option value="1">ì›”ìš”ì¼</option>
              <option value="5">ê¸ˆìš”ì¼</option>
            </select>
          </div>
        </div>

        <div
          style="
            margin-top: 16px;
            padding: 12px;
            background: var(--bg);
            border-radius: var(--radius);
            text-align: center;
          ">
          <label style="font-size: 0.75rem; color: var(--text-muted)">ìƒì„±ëœ í‘œí˜„ì‹</label>
          <div
            id="cron-preview"
            style="font-size: 1.3rem; font-family: monospace; color: var(--primary); margin-top: 4px">
            0 0 * * * *
          </div>
          <div id="cron-desc" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px"></div>
        </div>

        <div class="modal-actions">
          <button onclick="closeModal('modal-cron')">ì·¨ì†Œ</button>
          <button class="btn-primary" onclick="confirmCronBuilder()">ì ìš©</button>
        </div>
      </div>
    </div>

    <script>
      let currentConfig = null;
      let fileHandle = null;
      let hasOpenedFile = false;
      let dragDepth = 0;
      const SETTINGS_FILE_NAME = "settings.json";

      function getDefaultConfig() {
        return {
          sources: [],
          enable_periodic: true,
          enable_event_driven: true,
          exclude_patterns: ["*.tmp", "*.log", ".git/*", ".DS_Store"],
          max_backups: 10,
          backup_mode: "delta",
          full_backup_interval: 10,
          cron_schedule: "0 0 * * * *",
          enable_min_interval_by_size: true,
          metadata: {}
        };
      }

      async function loadFile() {
        if ("showOpenFilePicker" in window) {
          await loadFileWithFSAPI();
          return;
        }
        document.getElementById("file-input").click();
      }

      async function loadFileWithFSAPI() {
        try {
          const [handle] = await window.showOpenFilePicker({
            multiple: false,
            types: [
              {
                description: "JSON Files",
                accept: { "application/json": [".json"] }
              }
            ]
          });
          if (!handle) return;

          const file = await handle.getFile();
          await applyLoadedConfigFile(file, handle, false);
        } catch (err) {
          if (err.name !== "AbortError") {
            toast("íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: " + err.message, "error");
          }
        }
      }

      async function handleFileLoad(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          await applyLoadedConfigFile(file, null, false);
        } catch (err) {
          toast("íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: " + err.message, "error");
        }
        event.target.value = "";
      }

      async function applyLoadedConfigFile(file, handle, fromDrop) {
        if (!isSettingsJsonFileName(file.name)) {
          throw new Error(`"${SETTINGS_FILE_NAME}" íŒŒì¼ë§Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ íŒŒì¼: ${file.name}`);
        }

        let parsed;
        try {
          const content = await file.text();
          parsed = JSON.parse(content);
        } catch (err) {
          throw new Error("ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
        }

        const schemaErrors = validateLoadedSettingsSchema(parsed);
        if (schemaErrors.length > 0) {
          throw new Error("settings.json ì†ì„± ê²€ì¦ ì‹¤íŒ¨:\n" + schemaErrors.join("\n"));
        }

        currentConfig = parsed;
        fileHandle = handle || null;
        hasOpenedFile = true;
        populateUI();
        setSaveButtonEnabled(true);

        if (handle) {
          toast(`ì„¤ì • íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤: ${file.name}`, "success");
          return;
        }

        if (fromDrop) {
          toast("íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°ë¡œ ì„¤ì • íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ì œì•½ìœ¼ë¡œ ì €ì¥ ì‹œ ë‹¤ìš´ë¡œë“œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "success");
          return;
        }

        toast("ì„¤ì • íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ì œì•½ìœ¼ë¡œ ì €ì¥ ì‹œ ë‹¤ìš´ë¡œë“œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "success");
      }

      function isSettingsJsonFileName(name) {
        return (name || "").toLowerCase() === SETTINGS_FILE_NAME;
      }

      function isPlainObject(v) {
        return !!v && typeof v === "object" && !Array.isArray(v);
      }

      function isStringArray(v) {
        return Array.isArray(v) && v.every((x) => typeof x === "string");
      }

      function hasValidCronFields(expr) {
        return typeof expr === "string" && expr.trim().split(/\s+/).length >= 6;
      }

      function validateLoadedSettingsSchema(config) {
        const errors = [];

        if (!isPlainObject(config)) {
          errors.push("ë£¨íŠ¸ëŠ” JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return errors;
        }

        if (!Array.isArray(config.sources)) {
          errors.push("sourcesëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (typeof config.enable_periodic !== "boolean") {
          errors.push("enable_periodicì€ booleanì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (typeof config.enable_event_driven !== "boolean") {
          errors.push("enable_event_drivenì€ booleanì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (!isStringArray(config.exclude_patterns)) {
          errors.push("exclude_patternsëŠ” ë¬¸ìì—´ ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (!Number.isInteger(config.max_backups) || config.max_backups < 1) {
          errors.push("max_backupsëŠ” 1 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (!(config.backup_mode === "delta" || config.backup_mode === "copy")) {
          errors.push("backup_modeëŠ” 'delta' ë˜ëŠ” 'copy'ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (!Number.isInteger(config.full_backup_interval) || config.full_backup_interval < 1) {
          errors.push("full_backup_intervalì€ 1 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (!hasValidCronFields(config.cron_schedule)) {
          errors.push("cron_scheduleì€ ìµœì†Œ 6í•„ë“œ(ì´ˆ ë¶„ ì‹œ ì¼ ì›” ìš”ì¼)ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (typeof config.enable_min_interval_by_size !== "boolean") {
          errors.push("enable_min_interval_by_sizeëŠ” booleanì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        }
        if (!isPlainObject(config.metadata)) {
          errors.push("metadataëŠ” ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        }

        if (Array.isArray(config.sources)) {
          config.sources.forEach((src, idx) => {
            const label = `sources[${idx}]`;
            if (!isPlainObject(src)) {
              errors.push(`${label}ëŠ” ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
              return;
            }

            if (typeof src.source_dir !== "string" || src.source_dir.trim() === "") {
              errors.push(`${label}.source_dirì€ ë¹„ì–´ìˆì§€ ì•Šì€ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (!Array.isArray(src.backup_dirs) || !src.backup_dirs.every((v) => typeof v === "string")) {
              errors.push(`${label}.backup_dirsëŠ” ë¬¸ìì—´ ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (typeof src.enabled !== "boolean") {
              errors.push(`${label}.enabledëŠ” booleanì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            }

            if (src.exclude_patterns != null && !isStringArray(src.exclude_patterns)) {
              errors.push(`${label}.exclude_patternsëŠ” ë¬¸ìì—´ ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (src.max_backups != null && (!Number.isInteger(src.max_backups) || src.max_backups < 1)) {
              errors.push(`${label}.max_backupsëŠ” 1 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (
              src.backup_mode != null &&
              !(src.backup_mode === "delta" || src.backup_mode === "copy")
            ) {
              errors.push(`${label}.backup_modeëŠ” 'delta' ë˜ëŠ” 'copy'ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (
              src.full_backup_interval != null &&
              (!Number.isInteger(src.full_backup_interval) || src.full_backup_interval < 1)
            ) {
              errors.push(`${label}.full_backup_intervalì€ 1 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (src.cron_schedule != null && !hasValidCronFields(src.cron_schedule)) {
              errors.push(`${label}.cron_scheduleì€ ìµœì†Œ 6í•„ë“œì—¬ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (src.enable_event_driven != null && typeof src.enable_event_driven !== "boolean") {
              errors.push(`${label}.enable_event_drivenì€ booleanì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (src.enable_periodic != null && typeof src.enable_periodic !== "boolean") {
              errors.push(`${label}.enable_periodicì€ booleanì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            }
          });
        }

        return errors;
      }

      function isFileDrag(event) {
        const dt = event.dataTransfer;
        if (!dt || !dt.types) return false;
        return Array.from(dt.types).includes("Files");
      }

      function pickDroppedJsonFile(files) {
        const arr = Array.from(files || []);
        if (arr.length === 0) return null;

        return arr.find((f) => isSettingsJsonFileName(f.name)) || null;
      }

      async function getDroppedFileHandle(dataTransfer, fileName) {
        if (!dataTransfer || !dataTransfer.items) return null;

        for (const item of dataTransfer.items) {
          if (item.kind !== "file" || !item.getAsFileSystemHandle) continue;

          try {
            const handle = await item.getAsFileSystemHandle();
            if (handle && handle.kind === "file" && (!fileName || handle.name === fileName)) {
              return handle;
            }
          } catch (err) {
            // ignore and continue
          }
        }

        return null;
      }

      function setDndOverlay(active) {
        const overlay = document.getElementById("dnd-overlay");
        if (!overlay) return;
        overlay.classList.toggle("active", active);
      }

      async function handleGlobalDrop(event) {
        const dt = event.dataTransfer;
        const file = pickDroppedJsonFile(dt ? dt.files : []);

        if (!file) {
          toast(`"${SETTINGS_FILE_NAME}" íŒŒì¼ë§Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, "error");
          return;
        }

        let handle = null;
        try {
          handle = await getDroppedFileHandle(dt, file.name);
        } catch (err) {
          handle = null;
        }

        try {
          await applyLoadedConfigFile(file, handle, true);
        } catch (err) {
          toast("íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: " + err.message, "error");
        }
      }

      function setupGlobalDragAndDrop() {
        window.addEventListener("dragenter", (event) => {
          if (!isFileDrag(event)) return;
          event.preventDefault();
          dragDepth += 1;
          setDndOverlay(true);
        });

        window.addEventListener("dragover", (event) => {
          if (!isFileDrag(event)) return;
          event.preventDefault();
          if (event.dataTransfer) event.dataTransfer.dropEffect = "copy";
        });

        window.addEventListener("dragleave", (event) => {
          if (!isFileDrag(event)) return;
          event.preventDefault();
          dragDepth = Math.max(0, dragDepth - 1);
          if (dragDepth === 0) setDndOverlay(false);
        });

        window.addEventListener("drop", async (event) => {
          if (!isFileDrag(event)) return;
          event.preventDefault();
          dragDepth = 0;
          setDndOverlay(false);
          await handleGlobalDrop(event);
        });
      }

      function populateUI() {
        const c = currentConfig;
        document.getElementById("g-enable-periodic").checked = c.enable_periodic !== false;
        document.getElementById("g-enable-event").checked = c.enable_event_driven !== false;
        document.getElementById("g-max-backups").value = c.max_backups || 10;
        document.getElementById("g-backup-mode").value = c.backup_mode || "delta";
        document.getElementById("g-full-interval").value = c.full_backup_interval || 10;
        document.getElementById("g-cron").value = c.cron_schedule || "0 0 * * * *";
        document.getElementById("g-min-interval").checked = c.enable_min_interval_by_size !== false;
        document.getElementById("g-exclude").value = (c.exclude_patterns || []).join(", ");

        renderSources();
        syncPreviewIfVisible();
      }

      function renderSources() {
        const container = document.getElementById("sources-container");
        container.innerHTML = "";

        if (!currentConfig || !currentConfig.sources) {
          syncPreviewIfVisible();
          return;
        }

        currentConfig.sources.forEach((src, idx) => {
          const card = document.createElement("div");
          card.className = "source-card";
          card.innerHTML = `
      <div class="source-header">
        <h3>
          <span class="tag ${src.enabled ? "tag-enabled" : "tag-disabled"}">${src.enabled ? "ON" : "OFF"}</span>
          ${escHtml(src.source_dir)}
        </h3>
        <div class="actions">
          <button class="btn-sm" onclick="toggleSource(${idx})">${src.enabled ? "ë¹„í™œì„±í™”" : "í™œì„±í™”"}</button>
          <button class="btn-sm btn-danger" onclick="removeSource(${idx})">ì‚­ì œ</button>
        </div>
      </div>

      <div class="field">
        <label>source_dir</label>
        <div class="path-input-group">
          <input type="text" id="source-dir-${idx}" value="${escAttr(src.source_dir)}" onchange="updateSourceField(${idx}, 'source_dir', this.value)">
          <button class="btn-browse btn-sm" onclick="openBrowse('source', ${idx})">ğŸ“‚ ì°¾ê¸°</button>
        </div>
      </div>

      <div class="field">
        <label>backup_dirs</label>
        <div class="backup-dirs" id="backup-dirs-${idx}">
          ${(src.backup_dirs || [])
            .map(
              (bd, bi) => `
            <div class="backup-dir-row">
              <div class="path-input-group">
                <input type="text" value="${escAttr(bd)}" onchange="updateBackupDir(${idx}, ${bi}, this.value)">
                <button class="btn-browse btn-sm" onclick="openBrowse('backup', ${idx}, ${bi})">ğŸ“‚ ì°¾ê¸°</button>
                <button class="btn-sm btn-danger" onclick="removeBackupDir(${idx}, ${bi})">âœ•</button>
              </div>
            </div>
          `
            )
            .join("")}
          <div style="display:flex;gap:6px;margin-top:4px;">
            <button class="btn-sm" onclick="addBackupDir(${idx})">+ ì§ì ‘ ì…ë ¥</button>
            <button class="btn-sm btn-browse" onclick="openBrowse('backup-new', ${idx})">ğŸ“‚ ì°¾ê¸°ë¡œ ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h4 class="section-toggle${hasOverrides(src) ? " open" : ""}" onclick="toggleOverrides(this)">ì†ŒìŠ¤ë³„ ì„¤ì • ì˜¤ë²„ë¼ì´ë“œ</h4>
        <div class="overrides" style="margin-top:8px;${hasOverrides(src) ? "" : "display:none;"}">
          <div class="override-row">
            <label>exclude_patterns</label>
            <input type="text" value="${src.exclude_patterns ? src.exclude_patterns.join(", ") : ""}"
              placeholder="ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©"
              onchange="updateSourceOverride(${idx}, 'exclude_patterns', this.value)">
            <button class="btn-sm" onclick="resetOverride(${idx}, 'exclude_patterns', this)">reset</button>
          </div>
          <div class="override-row">
            <label>max_backups</label>
            <input type="number" min="1" value="${src.max_backups != null ? src.max_backups : ""}"
              placeholder="ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©"
              onchange="updateSourceOverride(${idx}, 'max_backups', this.value)">
            <button class="btn-sm" onclick="resetOverride(${idx}, 'max_backups', this)">reset</button>
          </div>
          <div class="override-row">
            <label>backup_mode</label>
            <select onchange="updateSourceOverride(${idx}, 'backup_mode', this.value)">
              <option value="" ${src.backup_mode == null ? "selected" : ""}>ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©</option>
              <option value="delta" ${src.backup_mode === "delta" ? "selected" : ""}>delta</option>
              <option value="copy" ${src.backup_mode === "copy" ? "selected" : ""}>copy</option>
            </select>
            <button class="btn-sm" onclick="resetOverride(${idx}, 'backup_mode', this)">reset</button>
          </div>
          <div class="override-row">
            <label>full_backup_interval</label>
            <input type="number" min="1" value="${src.full_backup_interval != null ? src.full_backup_interval : ""}"
              placeholder="ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©"
              onchange="updateSourceOverride(${idx}, 'full_backup_interval', this.value)">
            <button class="btn-sm" onclick="resetOverride(${idx}, 'full_backup_interval', this)">reset</button>
          </div>
          <div class="override-row">
            <label>cron_schedule</label>
            <input type="text" value="${src.cron_schedule || ""}"
              placeholder="ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©"
              onchange="updateSourceOverride(${idx}, 'cron_schedule', this.value)">
            <button class="btn-sm" onclick="openCronBuilder('source', ${idx})">ğŸ• ë¹Œë”</button>
            <button class="btn-sm" onclick="resetOverride(${idx}, 'cron_schedule', this)">reset</button>
          </div>
          <div class="override-row">
            <label>enable_event_driven</label>
            <select onchange="updateSourceOverride(${idx}, 'enable_event_driven', this.value)">
              <option value="" ${src.enable_event_driven == null ? "selected" : ""}>ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©</option>
              <option value="true" ${src.enable_event_driven === true ? "selected" : ""}>true</option>
              <option value="false" ${src.enable_event_driven === false ? "selected" : ""}>false</option>
            </select>
            <button class="btn-sm" onclick="resetOverride(${idx}, 'enable_event_driven', this)">reset</button>
          </div>
          <div class="override-row">
            <label>enable_periodic</label>
            <select onchange="updateSourceOverride(${idx}, 'enable_periodic', this.value)">
              <option value="" ${src.enable_periodic == null ? "selected" : ""}>ê¸€ë¡œë²Œ ì„¤ì • ì‚¬ìš©</option>
              <option value="true" ${src.enable_periodic === true ? "selected" : ""}>true</option>
              <option value="false" ${src.enable_periodic === false ? "selected" : ""}>false</option>
            </select>
            <button class="btn-sm" onclick="resetOverride(${idx}, 'enable_periodic', this)">reset</button>
          </div>
        </div>
      </div>
    `;
          container.appendChild(card);
        });

        syncPreviewIfVisible();
      }

      function hasOverrides(src) {
        return (
          src.exclude_patterns != null ||
          src.max_backups != null ||
          src.backup_mode != null ||
          src.full_backup_interval != null ||
          src.cron_schedule != null ||
          src.enable_event_driven != null ||
          src.enable_periodic != null
        );
      }

      function toggleOverrides(el) {
        el.classList.toggle("open");
        const div = el.nextElementSibling;
        div.style.display = div.style.display === "none" ? "" : "none";
      }

      // â”€â”€ Modal state â”€â”€
      let modalTarget = { type: "", sourceIdx: -1, backupIdx: -1 };

      function openBrowse(type, sourceIdx, backupIdx) {
        modalTarget = { type, sourceIdx, backupIdx: backupIdx != null ? backupIdx : -1 };
        document.getElementById("browse-path").value = "";
        // Pre-fill with current value
        if (type === "source") {
          document.getElementById("browse-path").value = currentConfig.sources[sourceIdx].source_dir || "";
        } else if (type === "backup" && backupIdx != null) {
          document.getElementById("browse-path").value = currentConfig.sources[sourceIdx].backup_dirs[backupIdx] || "";
        }
        document.getElementById("modal-browse").classList.add("active");
        setTimeout(() => document.getElementById("browse-path").focus(), 100);
      }

      function confirmBrowse() {
        const path = document.getElementById("browse-path").value.trim();
        if (!path) {
          toast("ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");
          return;
        }
        if (!isAbsolutePath(path)) {
          toast("ì ˆëŒ€ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”. (Unix: / ì‹œì‘, Windows: C:\\ ë“±)", "error");
          return;
        }

        applyPath(path);
        closeModal("modal-browse");
      }

      function applyPath(path) {
        const { type, sourceIdx, backupIdx } = modalTarget;
        if (type === "source") {
          currentConfig.sources[sourceIdx].source_dir = path;
        } else if (type === "backup") {
          currentConfig.sources[sourceIdx].backup_dirs[backupIdx] = path;
        } else if (type === "backup-new") {
          currentConfig.sources[sourceIdx].backup_dirs.push(path);
        }
        renderSources();
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }

      // â”€â”€ Cron Builder â”€â”€
      let cronTarget = { type: "global", sourceIdx: -1 };

      function openCronBuilder(type, sourceIdx) {
        cronTarget = { type, sourceIdx: sourceIdx != null ? sourceIdx : -1 };
        // Pre-fill from current value
        let current = "";
        if (type === "global") {
          current = document.getElementById("g-cron").value;
        } else if (type === "source" && currentConfig) {
          current = currentConfig.sources[sourceIdx].cron_schedule || "";
        }
        if (current) {
          parseCronToSelects(current);
        } else {
          resetCronSelects();
        }
        document.getElementById("cron-preset").value = "";
        updateCronPreview();
        document.getElementById("modal-cron").classList.add("active");
      }

      function parseCronToSelects(expr) {
        const parts = expr.trim().split(/\s+/);
        if (parts.length >= 6) {
          setSelectIfMatch("cron-sec", parts[0]);
          setSelectIfMatch("cron-min", parts[1]);
          setSelectIfMatch("cron-hour", parts[2]);
          setSelectIfMatch("cron-day", parts[3]);
          setSelectIfMatch("cron-month", parts[4]);
          setSelectIfMatch("cron-dow", parts[5]);
        }
      }

      function setSelectIfMatch(id, value) {
        const sel = document.getElementById(id);
        for (let i = 0; i < sel.options.length; i++) {
          if (sel.options[i].value === value) {
            sel.selectedIndex = i;
            return;
          }
        }
        // If no match, keep first option
        sel.selectedIndex = 0;
      }

      function resetCronSelects() {
        document.getElementById("cron-sec").value = "0";
        document.getElementById("cron-min").value = "0";
        document.getElementById("cron-hour").value = "*";
        document.getElementById("cron-day").value = "*";
        document.getElementById("cron-month").value = "*";
        document.getElementById("cron-dow").value = "*";
      }

      function applyCronPreset() {
        const preset = document.getElementById("cron-preset").value;
        if (preset) {
          parseCronToSelects(preset);
          updateCronPreview();
        }
      }

      function updateCronPreview() {
        const sec = document.getElementById("cron-sec").value;
        const min = document.getElementById("cron-min").value;
        const hour = document.getElementById("cron-hour").value;
        const day = document.getElementById("cron-day").value;
        const month = document.getElementById("cron-month").value;
        const dow = document.getElementById("cron-dow").value;
        const expr = `${sec} ${min} ${hour} ${day} ${month} ${dow}`;
        document.getElementById("cron-preview").textContent = expr;
        document.getElementById("cron-desc").textContent = describeCron(sec, min, hour, day, month, dow);
      }

      function describeCron(sec, min, hour, day, month, dow) {
        const parts = [];
        // Frequency
        if (sec !== "0" && sec !== "*") parts.push(sec.replace("*/", "") + "ì´ˆë§ˆë‹¤");
        if (min === "*") parts.push("ë§¤ë¶„");
        else if (min.startsWith("*/")) parts.push(min.replace("*/", "") + "ë¶„ë§ˆë‹¤");
        else if (min === "0" && hour !== "*") {
          /* skip, handled by hour */
        } else if (min === "0") parts.push("ì •ê°");

        if (hour === "*" && min !== "*") {
          /* every hour implied */
        } else if (hour === "*") parts.push("ë§¤ì‹œ");
        else if (hour.startsWith("*/")) parts.push(hour.replace("*/", "") + "ì‹œê°„ë§ˆë‹¤");
        else if (hour.includes("-")) parts.push(hour + "ì‹œ");
        else parts.push(hour + "ì‹œ");

        if (day !== "*") {
          if (day.includes(",")) parts.push(day + "ì¼");
          else parts.push(day + "ì¼");
        }
        if (month !== "*") {
          if (month.startsWith("*/")) parts.push(month.replace("*/", "") + "ê°œì›”ë§ˆë‹¤");
          else parts.push(month + "ì›”");
        }
        if (dow !== "*") {
          const dowMap = {
            0: "ì¼",
            1: "ì›”",
            2: "í™”",
            3: "ìˆ˜",
            4: "ëª©",
            5: "ê¸ˆ",
            6: "í† ",
            "1-5": "í‰ì¼",
            "0,6": "ì£¼ë§"
          };
          parts.push(dowMap[dow] || dow + "ìš”ì¼");
        }
        return parts.join(", ");
      }

      function confirmCronBuilder() {
        const expr = document.getElementById("cron-preview").textContent;
        if (cronTarget.type === "global") {
          document.getElementById("g-cron").value = expr;
        } else if (cronTarget.type === "source" && currentConfig) {
          currentConfig.sources[cronTarget.sourceIdx].cron_schedule = expr;
          renderSources();
        }
        syncPreviewIfVisible();
        closeModal("modal-cron");
        toast(`Cron í‘œí˜„ì‹ ì ìš©: ${expr}`, "success");
      }

      // Close modals on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document.querySelectorAll(".modal-overlay.active").forEach((m) => m.classList.remove("active"));
        }
      });

      // Close modals on overlay click
      document.querySelectorAll(".modal-overlay").forEach((overlay) => {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.classList.remove("active");
        });
      });

      function addSource() {
        if (!currentConfig) currentConfig = getDefaultConfig();
        currentConfig.sources.push({
          source_dir: "/path/to/source",
          backup_dirs: ["/path/to/backup"],
          enabled: true
        });
        renderSources();
      }

      function removeSource(idx) {
        if (confirm(`ì†ŒìŠ¤ "${currentConfig.sources[idx].source_dir}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          currentConfig.sources.splice(idx, 1);
          renderSources();
        }
      }

      function toggleSource(idx) {
        currentConfig.sources[idx].enabled = !currentConfig.sources[idx].enabled;
        renderSources();
      }

      function updateSourceField(idx, field, value) {
        currentConfig.sources[idx][field] = value;
        syncPreviewIfVisible();
      }

      function updateBackupDir(idx, bi, value) {
        currentConfig.sources[idx].backup_dirs[bi] = value;
        syncPreviewIfVisible();
      }

      function addBackupDir(idx) {
        currentConfig.sources[idx].backup_dirs.push("/path/to/backup");
        renderSources();
      }

      function removeBackupDir(idx, bi) {
        currentConfig.sources[idx].backup_dirs.splice(bi, 1);
        renderSources();
      }

      function updateSourceOverride(idx, key, value) {
        const src = currentConfig.sources[idx];
        if (value === "" || value == null) {
          delete src[key];
          syncPreviewIfVisible();
          return;
        }
        if (key === "exclude_patterns") {
          src[key] = value
            .split(",")
            .map((s) => s.trim())
            .filter((s) => s);
        } else if (key === "max_backups" || key === "full_backup_interval") {
          src[key] = parseInt(value, 10);
        } else if (key === "enable_event_driven" || key === "enable_periodic") {
          src[key] = value === "true";
        } else {
          src[key] = value;
        }
        syncPreviewIfVisible();
      }

      function resetOverride(idx, key, btn) {
        delete currentConfig.sources[idx][key];
        renderSources();
      }

      function collectConfig() {
        if (!currentConfig) currentConfig = getDefaultConfig();

        currentConfig.enable_periodic = document.getElementById("g-enable-periodic").checked;
        currentConfig.enable_event_driven = document.getElementById("g-enable-event").checked;
        currentConfig.max_backups = parseInt(document.getElementById("g-max-backups").value, 10) || 10;
        currentConfig.backup_mode = document.getElementById("g-backup-mode").value;
        currentConfig.full_backup_interval = parseInt(document.getElementById("g-full-interval").value, 10) || 10;
        currentConfig.cron_schedule = document.getElementById("g-cron").value;
        currentConfig.enable_min_interval_by_size = document.getElementById("g-min-interval").checked;

        const excludeStr = document.getElementById("g-exclude").value;
        currentConfig.exclude_patterns = excludeStr
          .split(",")
          .map((s) => s.trim())
          .filter((s) => s);

        if (!currentConfig.metadata) currentConfig.metadata = {};

        return currentConfig;
      }

      function validateConfig() {
        const config = collectConfig();
        const errors = [];

        // Global
        if (config.max_backups < 1) errors.push("ê¸€ë¡œë²Œ max_backupsëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        if (config.full_backup_interval < 1) errors.push("ê¸€ë¡œë²Œ full_backup_intervalì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        if (config.backup_mode === "delta" && config.max_backups < config.full_backup_interval) {
          errors.push(
            `ê¸€ë¡œë²Œ: delta ëª¨ë“œì—ì„œ max_backups(${config.max_backups})ëŠ” full_backup_interval(${config.full_backup_interval}) ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤. ë³µì›ì—ëŠ” full + ì´í›„ ëª¨ë“  incê°€ í•„ìš”í•©ë‹ˆë‹¤.`
          );
        }
        if (!config.cron_schedule || config.cron_schedule.trim().split(/\s+/).length < 6) {
          errors.push("ê¸€ë¡œë²Œ cron_scheduleì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ìµœì†Œ 6í•„ë“œ: ì´ˆ ë¶„ ì‹œ ì¼ ì›” ìš”ì¼)");
        }

        const seenSources = new Set();
        for (let i = 0; i < config.sources.length; i++) {
          const src = config.sources[i];
          const label = `ì†ŒìŠ¤[${i}] "${src.source_dir}"`;

          // Absolute path
          if (!isAbsolutePath(src.source_dir)) {
            errors.push(`${label}: source_dirì€ ì ˆëŒ€ê²½ë¡œì—¬ì•¼ í•©ë‹ˆë‹¤.`);
          }

          // Duplicate source
          if (seenSources.has(src.source_dir)) {
            errors.push(`${label}: ì¤‘ë³µëœ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ì…ë‹ˆë‹¤.`);
          }
          seenSources.add(src.source_dir);

          // Backup dirs
          const seenBackups = new Set();
          for (let j = 0; j < (src.backup_dirs || []).length; j++) {
            const bd = src.backup_dirs[j];
            if (!isAbsolutePath(bd)) {
              errors.push(`${label}: backup_dirs[${j}]ì€ ì ˆëŒ€ê²½ë¡œì—¬ì•¼ í•©ë‹ˆë‹¤.`);
            }
            if (bd === src.source_dir) {
              errors.push(`${label}: backup_dirs[${j}]ì´ ì†ŒìŠ¤ì™€ ë™ì¼í•©ë‹ˆë‹¤.`);
            }
            if (seenBackups.has(bd)) {
              errors.push(`${label}: backup_dirs[${j}] ì¤‘ë³µëœ ë°±ì—… ê²½ë¡œì…ë‹ˆë‹¤.`);
            }
            seenBackups.add(bd);
          }

          // Source overrides
          if (src.max_backups != null && src.max_backups < 1) {
            errors.push(`${label}: max_backupsëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
          }
          if (src.full_backup_interval != null && src.full_backup_interval < 1) {
            errors.push(`${label}: full_backup_intervalì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
          }
          if (src.cron_schedule && src.cron_schedule.trim().split(/\s+/).length < 6) {
            errors.push(`${label}: cron_scheduleì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          }
          // Delta mode: max_backups >= full_backup_interval
          const effMode = src.backup_mode || config.backup_mode;
          if (effMode === "delta") {
            const effMax = src.max_backups != null ? src.max_backups : config.max_backups;
            const effFbi = src.full_backup_interval != null ? src.full_backup_interval : config.full_backup_interval;
            if (effMax < effFbi) {
              errors.push(
                `${label}: delta ëª¨ë“œì—ì„œ max_backups(${effMax})ëŠ” full_backup_interval(${effFbi}) ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`
              );
            }
          }
        }

        if (errors.length === 0) {
          toast("ê²€ì¦ í†µê³¼! ëª¨ë“  ì„¤ì •ì´ ìœ íš¨í•©ë‹ˆë‹¤.", "success");
        } else {
          toast(`ê²€ì¦ ì‹¤íŒ¨: ${errors.length}ê°œ ì˜¤ë¥˜\n` + errors.join("\n"), "error");
        }
        return errors.length === 0;
      }

      function togglePreview() {
        const el = document.getElementById("json-preview");
        const actions = document.getElementById("json-preview-actions");
        if (el.style.display === "none" || !el.style.display) {
          renderPreviewJson();
          el.style.display = "block";
          actions.style.display = "flex";
        } else {
          el.style.display = "none";
          actions.style.display = "none";
        }
      }

      function getPreviewJsonText() {
        const config = collectConfig();
        const cleaned = JSON.parse(
          JSON.stringify(config, (key, value) => {
            if (value === null || value === undefined) return undefined;
            return value;
          })
        );
        return JSON.stringify(cleaned, null, 2);
      }

      function renderPreviewJson() {
        const el = document.getElementById("json-preview");
        el.textContent = getPreviewJsonText();
      }

      function isPreviewVisible() {
        const el = document.getElementById("json-preview");
        return !!el && el.style.display === "block";
      }

      function syncPreviewIfVisible() {
        if (isPreviewVisible()) {
          renderPreviewJson();
        }
      }

      function setupPreviewAutoRefresh() {
        const ids = [
          "g-enable-periodic",
          "g-enable-event",
          "g-max-backups",
          "g-backup-mode",
          "g-full-interval",
          "g-cron",
          "g-min-interval",
          "g-exclude"
        ];

        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("input", syncPreviewIfVisible);
          el.addEventListener("change", syncPreviewIfVisible);
        });
      }

      async function copyPreviewJson() {
        const text = getPreviewJsonText();
        renderPreviewJson();

        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            fallbackCopyText(text);
          }
          toast("JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (err) {
          toast("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: " + err.message, "error");
        }
      }

      function fallbackCopyText(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "absolute";
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(textarea);
        if (!ok) {
          throw new Error("ë¸Œë¼ìš°ì €ì—ì„œ í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
      }

      function saveFile() {
        if (!hasOpenedFile) {
          toast("ë¨¼ì € ì„¤ì • íŒŒì¼ì„ ì—´ì–´ì£¼ì„¸ìš”.", "error");
          return;
        }

        const config = collectConfig();
        if (!validateConfig()) return;

        if (fileHandle) {
          saveToOpenedFile(config);
          return;
        }

        // File System Access API ì§€ì› ì‹œ ìƒˆ íŒŒì¼ ì €ì¥(ì €ì¥ ìœ„ì¹˜ ì„ íƒ)
        if ("showSaveFilePicker" in window) {
          saveAsWithFSAPI(config);
        } else {
          downloadFile();
        }
      }

      async function saveToOpenedFile(config) {
        try {
          await writeConfigToHandle(fileHandle, config);
          const name = fileHandle && fileHandle.name ? fileHandle.name : "ì—´ë¦° íŒŒì¼";
          toast(`íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${name}`, "success");
        } catch (err) {
          toast("ì €ì¥ ì‹¤íŒ¨: " + err.message, "error");
        }
      }

      async function saveAsWithFSAPI(config) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: "settings.json",
            types: [
              {
                description: "JSON Files",
                accept: { "application/json": [".json"] }
              }
            ]
          });
          await writeConfigToHandle(handle, config);
          fileHandle = handle;
          toast("íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (err) {
          if (err.name !== "AbortError") {
            toast("ì €ì¥ ì‹¤íŒ¨: " + err.message, "error");
          }
        }
      }

      async function writeConfigToHandle(handle, config) {
        const writable = await handle.createWritable();
        await writable.write(JSON.stringify(config, null, 2));
        await writable.close();
      }

      function downloadFile() {
        const config = collectConfig();
        const json = JSON.stringify(config, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "settings.json";
        a.click();
        URL.revokeObjectURL(url);
        toast("ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      }

      function toast(msg, type) {
        const existing = document.querySelector(".toast");
        if (existing) existing.remove();

        const el = document.createElement("div");
        el.className = `toast toast-${type}`;
        el.style.whiteSpace = "pre-wrap";
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), type === "error" ? 6000 : 3000);
      }

      function isAbsolutePath(p) {
        if (!p) return false;
        // Unix: /path/to/dir
        if (p.startsWith("/")) return true;
        // Windows: C:\, D:\, C:/, D:/ etc.
        if (/^[A-Za-z]:[\\\/]/.test(p)) return true;
        return false;
      }

      function escHtml(s) {
        const d = document.createElement("div");
        d.textContent = s || "";
        return d.innerHTML;
      }

      function escAttr(s) {
        return (s || "").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function newConfig() {
        if (currentConfig && currentConfig.sources.length > 0) {
          if (!confirm("í˜„ì¬ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;
        }
        currentConfig = getDefaultConfig();
        fileHandle = null;
        hasOpenedFile = false;
        setSaveButtonEnabled(false);
        populateUI();
        toast("ìƒˆ ì„¤ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
      }

      function setSaveButtonEnabled(enabled) {
        const btn = document.getElementById("save-btn");
        if (!btn) return;
        btn.disabled = !enabled;
      }

      // Init with empty state
      currentConfig = getDefaultConfig();
      setSaveButtonEnabled(false);
      populateUI();
      setupGlobalDragAndDrop();
      setupPreviewAutoRefresh();
    </script>
  </body>
</html>
